---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import { getCollection } from 'astro:content';
import FormattedDate from '../../components/FormattedDate.astro';

export async function getStaticPaths() {
	const allthoughts = await getCollection('thoughts');
	const allLab = await getCollection('lab');
	const allGarden = await getCollection('garden');

	// Combine all items to find unique tags
	const allItems = [...allthoughts, ...allLab, ...allGarden];
	const uniqueTags = [...new Set(allItems.map((item) => item.data.tags || []).flat())];

	return uniqueTags.map((tag) => {
		const filteredThoughts = allthoughts.filter((item) => item.data.tags?.some(t => t.toLowerCase() === tag.toLowerCase()));
		const filteredLab = allLab.filter((item) => item.data.tags?.some(t => t.toLowerCase() === tag.toLowerCase()));
		const filteredGarden = allGarden.filter((item) => item.data.tags?.some(t => t.toLowerCase() === tag.toLowerCase()));
		return {
			params: { tag },
			props: {
				tag,
				thoughts: filteredThoughts,
				lab: filteredLab,
				garden: filteredGarden,
			},
		};
	});
}

const { tag, thoughts, lab, garden } = Astro.props;
---

<Layout title={`${tag} | Topics`}>
	<Header />

	<main class="pt-32 pb-20 px-6 font-sans min-h-screen">
		<div class="max-w-7xl mx-auto">
			
			<!-- Header -->
			<header class="mb-16">
				<div class="inline-block px-4 py-1 text-xs font-mono text-purple-200 border border-purple-900/50 rounded-full bg-purple-900/10 tracking-widest mb-4 uppercase">
					Topic
				</div>
				<h1 class="text-5xl md:text-7xl font-bold font-serif text-white mb-6 capitalize">
					{tag}
				</h1>
				<p class="text-xl text-slate-300 font-light max-w-2xl">
					Curated collection of experiments, notes, and thoughts.
				</p>
			</header>

			<!-- Grid Layout -->
			<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
				
				<!-- Lab Column -->
				<div class="space-y-6">
					<div class="flex items-center gap-3 mb-2">
						<span class="text-amber-400 bg-amber-400/10 p-2 rounded-lg"><i class="fas fa-flask"></i></span>
						<h2 class="text-2xl font-bold text-white">Lab</h2>
					</div>
					{lab.length > 0 ? (
						<div class="space-y-4">
							{lab.map((project) => (
								<a href={`/lab/${project.slug}/`} class="block group">
									<div class="bg-white/5 backdrop-blur-md border border-white/10 rounded-2xl overflow-hidden hover:border-amber-500/30 transition-all duration-300 hover:-translate-y-1 hover:shadow-lg hover:shadow-amber-900/10">
										{project.data.heroImage && (
											<div class="h-32 bg-cover bg-center opacity-80 group-hover:opacity-100 transition-opacity" style={`background-image: url('${project.data.heroImage}')`}></div>
										)}
										<div class="p-5">
											<h3 class="text-lg font-bold text-white mb-2 group-hover:text-amber-300 transition-colors">{project.data.title}</h3>
											<p class="text-slate-400 text-sm line-clamp-2">{project.data.description}</p>
										</div>
									</div>
								</a>
							))}
						</div>
					) : (
						<div class="p-6 border border-dashed border-white/10 rounded-2xl text-slate-500 text-sm italic text-center">
							No experiments yet.
						</div>
					)}
				</div>

				<!-- Garden Column -->
				<div class="space-y-6">
					<div class="flex items-center gap-3 mb-2">
						 <span class="text-emerald-400 bg-emerald-400/10 p-2 rounded-lg"><i class="fas fa-seedling"></i></span>
						<h2 class="text-2xl font-bold text-white">Garden</h2>
					</div>
					{garden.length > 0 ? (
						<div class="space-y-4">
							{garden.map((note) => (
								<a href={`/garden/${note.slug}/`} class="block group">
									<div class="p-5 bg-white/5 backdrop-blur-md border border-white/10 rounded-2xl hover:border-emerald-500/30 transition-all duration-300 hover:-translate-y-1 hover:shadow-lg hover:shadow-emerald-900/10">
										<h3 class="text-lg font-bold text-white mb-2 group-hover:text-emerald-300 transition-colors">{note.data.title}</h3>
										<p class="text-slate-400 text-sm mb-3 line-clamp-2">{note.data.description}</p>
										<div class="text-xs text-slate-500 font-mono flex items-center gap-2">
											<i class="far fa-clock"></i> <FormattedDate date={note.data.updatedDate} />
										</div>
									</div>
								</a>
							))}
						</div>
					) : (
						<div class="p-6 border border-dashed border-white/10 rounded-2xl text-slate-500 text-sm italic text-center">
							No notes planted.
						</div>
					)}
				</div>

				<!-- Thoughts Column -->
				<div class="space-y-6">
					<div class="flex items-center gap-3 mb-2">
						 <span class="text-blue-400 bg-blue-400/10 p-2 rounded-lg"><i class="fas fa-feather-alt"></i></span>
						<h2 class="text-2xl font-bold text-white">Thoughts</h2>
					</div>
					 {thoughts.length > 0 ? (
						<div class="space-y-4">
							{thoughts.map((post) => (
								<a href={`/thoughts/${post.slug}/`} class="block group">
									<div class="p-5 bg-white/5 backdrop-blur-md border border-white/10 rounded-2xl hover:border-blue-500/30 transition-all duration-300 hover:-translate-y-1 hover:shadow-lg hover:shadow-blue-900/10">
										 <div class="text-xs text-blue-300 font-mono mb-2"><FormattedDate date={post.data.pubDate} /></div>
										<h3 class="text-lg font-bold text-white mb-2 group-hover:text-blue-300 transition-colors">{post.data.title}</h3>
										<p class="text-slate-400 text-sm line-clamp-2">{post.data.description}</p>
									</div>
								</a>
							))}
						</div>
					) : (
						<div class="p-6 border border-dashed border-white/10 rounded-2xl text-slate-500 text-sm italic text-center">
							No thoughts recorded.
						</div>
					)}
				</div>

			</div>
		</div>
	</main>
</Layout>
